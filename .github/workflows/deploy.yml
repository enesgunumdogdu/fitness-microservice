name: CI/CD Pipeline - Deploy to Production

on:
  push:
    branches: [prod]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Detect Changes
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      configserver: ${{ steps.filter.outputs.configserver }}
      eureka: ${{ steps.filter.outputs.eureka }}
      gateway: ${{ steps.filter.outputs.gateway }}
      userservice: ${{ steps.filter.outputs.userservice }}
      activityservice: ${{ steps.filter.outputs.activityservice }}
      aiservice: ${{ steps.filter.outputs.aiservice }}
      frontend: ${{ steps.filter.outputs.frontend }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            configserver:
              - 'configserver/**'
            eureka:
              - 'eureka/**'
            gateway:
              - 'gateway/**'
            userservice:
              - 'userservice/**'
            activityservice:
              - 'activityservice/**'
            aiservice:
              - 'aiservice/**'
            frontend:
              - 'frontend/**'
            infrastructure:
              - 'docker-compose.yml'
              - 'docker-compose.*.yml'
              - 'nginx/**'

  # ============================================
  # Build & Test - Backend Services
  # ============================================
  build-configserver:
    name: Build ConfigServer
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.configserver == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: configserver
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-eureka:
    name: Build Eureka
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.eureka == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: eureka
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-gateway:
    name: Build Gateway
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.gateway == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: gateway
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-userservice:
    name: Build UserService
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.userservice == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: userservice
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-activityservice:
    name: Build ActivityService
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.activityservice == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: activityservice
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-aiservice:
    name: Build AIService
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.aiservice == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: aiservice
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  # ============================================
  # Build - Frontend
  # ============================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_KEYCLOAK_URL: ${{ secrets.VITE_KEYCLOAK_URL }}

  # ============================================
  # Deploy to Production
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs:
      - changes
      - build-configserver
      - build-eureka
      - build-gateway
      - build-userservice
      - build-activityservice
      - build-aiservice
      - build-frontend
    if: always() && !failure() && !cancelled()
    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        env:
          CHANGED_CONFIGSERVER: ${{ needs.changes.outputs.configserver }}
          CHANGED_EUREKA: ${{ needs.changes.outputs.eureka }}
          CHANGED_GATEWAY: ${{ needs.changes.outputs.gateway }}
          CHANGED_USERSERVICE: ${{ needs.changes.outputs.userservice }}
          CHANGED_ACTIVITYSERVICE: ${{ needs.changes.outputs.activityservice }}
          CHANGED_AISERVICE: ${{ needs.changes.outputs.aiservice }}
          CHANGED_FRONTEND: ${{ needs.changes.outputs.frontend }}
          CHANGED_INFRASTRUCTURE: ${{ needs.changes.outputs.infrastructure }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: CHANGED_CONFIGSERVER,CHANGED_EUREKA,CHANGED_GATEWAY,CHANGED_USERSERVICE,CHANGED_ACTIVITYSERVICE,CHANGED_AISERVICE,CHANGED_FRONTEND,CHANGED_INFRASTRUCTURE
          script: |
            set -e

            echo "========================================="
            echo "Starting deployment at $(date)"
            echo "========================================="

            cd ~/fitness-microservice

            echo "Pulling latest changes from prod branch..."
            git fetch origin prod
            git checkout prod
            git pull origin prod

            # Build list of changed services (using docker-compose service names)
            SERVICES_TO_BUILD=""

            if [ "$CHANGED_INFRASTRUCTURE" = "true" ]; then
              echo "Infrastructure changed - rebuilding ALL services"
              REBUILD_ALL=true
            else
              REBUILD_ALL=false
              if [ "$CHANGED_CONFIGSERVER" = "true" ]; then
                SERVICES_TO_BUILD="$SERVICES_TO_BUILD config-server"
                echo "Will rebuild: config-server"
              fi
              if [ "$CHANGED_EUREKA" = "true" ]; then
                SERVICES_TO_BUILD="$SERVICES_TO_BUILD eureka-server"
                echo "Will rebuild: eureka-server"
              fi
              if [ "$CHANGED_GATEWAY" = "true" ]; then
                SERVICES_TO_BUILD="$SERVICES_TO_BUILD gateway"
                echo "Will rebuild: gateway"
              fi
              if [ "$CHANGED_USERSERVICE" = "true" ]; then
                SERVICES_TO_BUILD="$SERVICES_TO_BUILD user-service"
                echo "Will rebuild: user-service"
              fi
              if [ "$CHANGED_ACTIVITYSERVICE" = "true" ]; then
                SERVICES_TO_BUILD="$SERVICES_TO_BUILD activity-service"
                echo "Will rebuild: activity-service"
              fi
              if [ "$CHANGED_AISERVICE" = "true" ]; then
                SERVICES_TO_BUILD="$SERVICES_TO_BUILD ai-service"
                echo "Will rebuild: ai-service"
              fi
              if [ "$CHANGED_FRONTEND" = "true" ]; then
                SERVICES_TO_BUILD="$SERVICES_TO_BUILD frontend"
                echo "Will rebuild: frontend"
              fi
            fi

            if [ "$REBUILD_ALL" = "true" ]; then
              echo "Rebuilding all services..."
              docker-compose down --remove-orphans
              docker-compose build --no-cache
              docker-compose up -d
            elif [ -n "$SERVICES_TO_BUILD" ]; then
              echo "Building changed services:$SERVICES_TO_BUILD"
              docker-compose build --no-cache $SERVICES_TO_BUILD
              echo "Restarting changed services..."
              docker-compose up -d --no-deps $SERVICES_TO_BUILD
            else
              echo "No services changed - ensuring all services are running"
              docker-compose up -d
            fi

            echo "Waiting for services to be healthy..."
            sleep 30

            echo "Service status:"
            docker-compose ps

            echo "========================================="
            echo "Deployment completed at $(date)"
            echo "========================================="
