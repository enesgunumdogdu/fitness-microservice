name: CI/CD Pipeline - Deploy to Production

on:
  push:
    branches: [prod]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Detect Changes
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      configserver: ${{ steps.filter.outputs.configserver }}
      eureka: ${{ steps.filter.outputs.eureka }}
      gateway: ${{ steps.filter.outputs.gateway }}
      userservice: ${{ steps.filter.outputs.userservice }}
      activityservice: ${{ steps.filter.outputs.activityservice }}
      aiservice: ${{ steps.filter.outputs.aiservice }}
      frontend: ${{ steps.filter.outputs.frontend }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            configserver:
              - 'configserver/**'
            eureka:
              - 'eureka/**'
            gateway:
              - 'gateway/**'
            userservice:
              - 'userservice/**'
            activityservice:
              - 'activityservice/**'
            aiservice:
              - 'aiservice/**'
            frontend:
              - 'frontend/**'
            infrastructure:
              - 'docker-compose.yml'
              - 'nginx/**'
              - '.github/workflows/**'

  # ============================================
  # Build & Test - Backend Services
  # ============================================
  build-configserver:
    name: Build ConfigServer
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.configserver == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: configserver
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-eureka:
    name: Build Eureka
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.eureka == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: eureka
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-gateway:
    name: Build Gateway
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.gateway == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: gateway
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-userservice:
    name: Build UserService
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.userservice == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: userservice
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-activityservice:
    name: Build ActivityService
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.activityservice == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: activityservice
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  build-aiservice:
    name: Build AIService
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.aiservice == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: Build and test
        working-directory: aiservice
        run: |
          chmod +x mvnw
          ./mvnw clean verify -B

  # ============================================
  # Build - Frontend
  # ============================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_KEYCLOAK_URL: ${{ secrets.VITE_KEYCLOAK_URL }}

  # ============================================
  # Deploy to Production
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs:
      - changes
      - build-configserver
      - build-eureka
      - build-gateway
      - build-userservice
      - build-activityservice
      - build-aiservice
      - build-frontend
    if: always() && !failure() && !cancelled()
    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "========================================="
            echo "Starting deployment at $(date)"
            echo "========================================="

            cd ~/fitness-microservice

            echo "Pulling latest changes from prod branch..."
            git fetch origin prod
            git checkout prod
            git pull origin prod

            echo "Stopping existing containers..."
            docker-compose down --remove-orphans

            echo "Building new images..."
            docker-compose build --no-cache

            echo "Starting services..."
            docker-compose up -d

            echo "Waiting for services to be healthy..."
            sleep 30

            echo "Service status:"
            docker-compose ps

            echo "========================================="
            echo "Deployment completed at $(date)"
            echo "========================================="
